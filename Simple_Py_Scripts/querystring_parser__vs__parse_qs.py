#!/usr/bin/env python3
# -*- coding: utf-8 -*-

__author__ = 'ipetrash'


# SOURCE: https://github.com/bernii/querystring-parser


from urllib.parse import parse_qs

# pip install querystring_parser
from querystring_parser import parser


data = 'unsorted%5Badd%5D%5B0%5D%5Buid%5D=ca590aa1a0be97cb04c970e24190ba06f58d974c83534ac1ddaffb9bcc87&unsorted%5Badd%5D%5B0%5D%5Bcategory%5D=forms&unsorted%5Badd%5D%5B0%5D%5Bsource_data%5D%5Bform_id%5D=960973&unsorted%5Badd%5D%5B0%5D%5Bsource_data%5D%5Bform_type%5D=1&unsorted%5Badd%5D%5B0%5D%5Bsource_data%5D%5Bfrom%5D=%D0%97%D0%B0%D1%8F%D0%B2%D0%BA%D0%B0+%D1%81+%D1%81%D0%B0%D0%B9%D1%82%D0%B0+%E2%84%96960973+%D0%B8%D0%B7+%D1%84%D0%BE%D1%80%D0%BC%D1%8B+%C2%AB%D0%A4%D0%BE%D1%80%D0%BC%D0%B0+%231656686574%C2%BB&unsorted%5Badd%5D%5B0%5D%5Bsource_data%5D%5Bform_name%5D=%D0%A4%D0%BE%D1%80%D0%BC%D0%B0+%231656686574&unsorted%5Badd%5D%5B0%5D%5Bsource_data%5D%5Borigin%5D%5Bip%5D=37.112.0.90&unsorted%5Badd%5D%5B0%5D%5Bsource_data%5D%5Borigin%5D%5Bdatetime%5D=1657088615&unsorted%5Badd%5D%5B0%5D%5Bsource_data%5D%5Borigin%5D%5Breferer%5D=https%3A%2F%2Furl%2F&unsorted%5Badd%5D%5B0%5D%5Bsource_data%5D%5Bdata%5D%5Bname_2%5D%5Btype%5D=text&unsorted%5Badd%5D%5B0%5D%5Bsource_data%5D%5Bdata%5D%5Bname_2%5D%5Bid%5D=name_2&unsorted%5Badd%5D%5B0%5D%5Bsource_data%5D%5Bdata%5D%5Bname_2%5D%5Belement_type%5D=2&unsorted%5Badd%5D%5B0%5D%5Bsource_data%5D%5Bdata%5D%5Bname_2%5D%5Bname%5D=%D0%9D%D0%B0%D0%B7%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5+%D1%81%D0%B4%D0%B5%D0%BB%D0%BA%D0%B8&unsorted%5Badd%5D%5B0%5D%5Bsource_data%5D%5Bdata%5D%5Bname_2%5D%5Bvalue%5D=%D0%B2%D1%84s%D1%8B%D1%86%D0%B2&unsorted%5Badd%5D%5B0%5D%5Bsource_data%5D%5Bdate%5D=1657088615&unsorted%5Badd%5D%5B0%5D%5Bdate_create%5D=1657088615&unsorted%5Badd%5D%5B0%5D%5Bdata%5D%5Bleads%5D%5B0%5D%5Blast_modified%5D=1657088618&unsorted%5Badd%5D%5B0%5D%5Bdata%5D%5Bleads%5D%5B0%5D%5Bname%5D=%D0%B2%D1%84s%D1%8B%D1%86%D0%B2&unsorted%5Badd%5D%5B0%5D%5Bdata%5D%5Bleads%5D%5B0%5D%5Bpipeline_id%5D=5549659&unsorted%5Badd%5D%5B0%5D%5Bdata%5D%5Bleads%5D%5B0%5D%5Bmodified_user_id%5D=0&unsorted%5Badd%5D%5B0%5D%5Bdata%5D%5Bleads%5D%5B0%5D%5Bdate_create%5D=1657088615&unsorted%5Badd%5D%5B0%5D%5Bdata%5D%5Bleads%5D%5B0%5D%5Bcustom_fields%5D%5B0%5D%5Bid%5D=37475&unsorted%5Badd%5D%5B0%5D%5Bdata%5D%5Bleads%5D%5B0%5D%5Bcustom_fields%5D%5B0%5D%5Bcode%5D=REFERRER&unsorted%5Badd%5D%5B0%5D%5Bdata%5D%5Bleads%5D%5B0%5D%5Bcustom_fields%5D%5B0%5D%5Bvalues%5D%5B0%5D%5Bvalue%5D=https%3A%2F%2Furl%2F&unsorted%5Badd%5D%5B0%5D%5Bdata%5D%5Bleads%5D%5B0%5D%5Bvisitor_uid%5D=12994359-6562-448b-a18a-ae06fe5cd9c7&unsorted%5Badd%5D%5B0%5D%5Bdata%5D%5Bleads%5D%5B0%5D%5Bgso_session_uid%5D=e2a923a2-4a12-4795-81d2-2ca5865542dc&unsorted%5Badd%5D%5B0%5D%5Bdata%5D%5Bleads%5D%5B0%5D%5Bform_request_id%5D=0000000000&unsorted%5Badd%5D%5B0%5D%5Bpipeline_id%5D=5549659&unsorted%5Badd%5D%5B0%5D%5Baccount_id%5D=30256624&unsorted%5Badd%5D%5B0%5D%5Brequest_id%5D=0&unsorted%5Badd%5D%5B0%5D%5Bsource_id%5D=11874775&unsorted%5Badd%5D%5B0%5D%5Blead_id%5D=182405&unsorted%5Badd%5D%5B0%5D%5Bcreated_at%5D=1657088615&account%5Bsubdomain%5D=nick42&account%5Bid%5D=30256624&account%5B_links%5D%5Bself%5D=https%3A%2F%2Furl'

print(parse_qs(data))

print(parser.parse(data, normalized=True))
# {'unsorted': {'add': [{'uid': 'ca590aa1a0be97cb04c970e24190ba06f58d974c83534ac1ddaffb9bcc87', 'category': 'forms', 'source_data': {'form_id': '960973', 'form_type': '1', 'from': 'Заявка с сайта №960973 из формы «Форма #1656686574»', 'form_name': 'Форма #1656686574', 'origin': {'ip': '37.112.0.90', 'datetime': '1657088615', 'referer': 'https://url/'}, 'data': {'name_2': {'type': 'text', 'id': 'name_2', 'element_type': '2', 'name': 'Название сделки', 'value': 'вфsыцв'}}, 'date': '1657088615'}, 'date_create': '1657088615', 'data': {'leads': [{'last_modified': '1657088618', 'name': 'вфsыцв', 'pipeline_id': '5549659', 'modified_user_id': '0', 'date_create': '1657088615', 'custom_fields': [{'id': '37475', 'code': 'REFERRER', 'values': [{'value': 'https://url/'}]}], 'visitor_uid': '12994359-6562-448b-a18a-ae06fe5cd9c7', 'gso_session_uid': 'e2a923a2-4a12-4795-81d2-2ca5865542dc', 'form_request_id': '0000000000'}]}, 'pipeline_id': '5549659', 'account_id': '30256624', 'request_id': '0', 'source_id': '11874775', 'lead_id': '182405', 'created_at': '1657088615'}]}, 'account': {'subdomain': 'nick42', 'id': '30256624', '_links': {'self': 'https://url'}}}

print(parser.parse(data))
# {'unsorted': {'add': {0: {'uid': 'ca590aa1a0be97cb04c970e24190ba06f58d974c83534ac1ddaffb9bcc87', 'category': 'forms', 'source_data': {'form_id': '960973', 'form_type': '1', 'from': 'Заявка с сайта №960973 из формы «Форма #1656686574»', 'form_name': 'Форма #1656686574', 'origin': {'ip': '37.112.0.90', 'datetime': '1657088615', 'referer': 'https://url/'}, 'data': {'name_2': {'type': 'text', 'id': 'name_2', 'element_type': '2', 'name': 'Название сделки', 'value': 'вфsыцв'}}, 'date': '1657088615'}, 'date_create': '1657088615', 'data': {'leads': {0: {'last_modified': '1657088618', 'name': 'вфsыцв', 'pipeline_id': '5549659', 'modified_user_id': '0', 'date_create': '1657088615', 'custom_fields': {0: {'id': '37475', 'code': 'REFERRER', 'values': {0: {'value': 'https://url/'}}}}, 'visitor_uid': '12994359-6562-448b-a18a-ae06fe5cd9c7', 'gso_session_uid': 'e2a923a2-4a12-4795-81d2-2ca5865542dc', 'form_request_id': '0000000000'}}}, 'pipeline_id': '5549659', 'account_id': '30256624', 'request_id': '0', 'source_id': '11874775', 'lead_id': '182405', 'created_at': '1657088615'}}}, 'account': {'subdomain': 'nick42', 'id': '30256624', '_links': {'self': 'https://url'}}}
